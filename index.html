<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matriu Impacte-Esforç - Suara Cooperativa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 20px;
            width: 95vw;
            height: 90vh;
            max-width: 1400px;
            max-height: 900px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #4a5568 0%, #718096 100%);
            color: white;
            border-radius: 10px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
        }
        
        .header p {
            margin: 8px 0 0 0;
            font-size: 1em;
            opacity: 0.9;
        }
        
        #chartDiv {
            width: 100%;
            height: calc(100% - 180px);
            min-height: 500px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .control-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Matriu Impacte-Esforç</h1>
            <p>33 Propostes d'Acció</p>
        </div>
        
        <div class="controls">
            <button class="control-btn active" onclick="showAllCategories()">Totes les Categories</button>
            <button class="control-btn" onclick="filterByCategory('S')">Seguretat de la Informació</button>
            <button class="control-btn" onclick="filterByCategory('G')">Governança i Arquitectura</button>
            <button class="control-btn" onclick="filterByCategory('I')">Infraestructura</button>
            <button class="control-btn" onclick="filterByCategory('A')">Automatització i Integració</button>
            <button class="control-btn" onclick="filterByCategory('D')">Documentació i Estandardització</button>
            <button class="control-btn" onclick="resetZoom()">Reset Zoom</button>
        </div>
        
        <div class="controls" style="margin-top: 10px;">
            <button class="control-btn" onclick="filterByPriority('urgent')">Prioritat Urgent</button>
            <button class="control-btn" onclick="filterByPriority('mitjana')">Prioritat Mitjana</button>
            <button class="control-btn" onclick="filterByPriority('estrategica')">Prioritat Estratègica</button>
        </div>
        
        <div id="chartDiv"></div>
    </div>

    <script>
        // Dades de les 33 propostes d'acció
        const acciones = [
            {codi: 'S1', impacte: 10, esforç: 8, modul: 'SAP', item: 2, descripcio: 'Garantir PCI-DSS per servidors financers'},
            {codi: 'S2', impacte: 9, esforç: 8, modul: 'Hubspot i Drupal', item: 4, descripcio: 'Establir repositori únic dades bancàries'},
            {codi: 'S3', impacte: 9, esforç: 6, modul: 'SAP', item: 1, descripcio: 'Implementar protocols encriptació TLS/VPN'},
            {codi: 'S4', impacte: 8, esforç: 6, modul: 'Hubspot i Drupal', item: 5, descripcio: 'Definir entorn proves versions beta'},
            {codi: 'S5', impacte: 10, esforç: 9, modul: 'General', item: 27, descripcio: 'Aplicar RBAC/ABAC homogeni'},
            {codi: 'S6', impacte: 10, esforç: 5, modul: 'General', item: 29, descripcio: 'Assegurar compliment AI Act'},
            {codi: 'S7', impacte: 10, esforç: 7, modul: 'Jano', item: 3, descripcio: 'Definir procés backup Jano'},
            {codi: 'S8', impacte: 9, esforç: 5, modul: 'Casal TV', item: 8, descripcio: 'Crear política accés Google Workspace'},
            {codi: 'S9', impacte: 10, esforç: 6, modul: 'Llars connectades', item: 9, descripcio: 'Política consentiment dades biomètriques'},
            {codi: 'S10', impacte: 6, esforç: 3, modul: 'SAP', item: 10, descripcio: 'Validar política backup SAP'},
            {codi: 'S11', impacte: 5, esforç: 3, modul: 'Hubspot i Drupal', item: 12, descripcio: 'Revisar permisos equips Hubspot'},
            {codi: 'S12', impacte: 6, esforç: 3, modul: 'Hubspot i Drupal', item: 16, descripcio: 'Validar backups Moodle/AWS'},
            {codi: 'G1', impacte: 9, esforç: 9, modul: 'General', item: 19, descripcio: 'Pla validació correctesa dades'},
            {codi: 'G2', impacte: 9, esforç: 10, modul: 'General', item: 20, descripcio: 'Mòdul centralitzat sanejament dades'},
            {codi: 'G3', impacte: 8, esforç: 8, modul: 'General', item: 30, descripcio: 'Consolidar dades mèdiques duplicades'},
            {codi: 'G4', impacte: 9, esforç: 6, modul: 'Middleware N8N/MongoDB', item: 6, descripcio: 'Persistència PostgreSQL N8N'},
            {codi: 'G5', impacte: 9, esforç: 9, modul: 'General', item: 28, descripcio: 'Ens centralitzat gestió usuaris'},
            {codi: 'G6', impacte: 9, esforç: 6, modul: 'Middleware N8N/MongoDB', item: 31, descripcio: 'Definir casos ús IA Engine'},
            {codi: 'G7', impacte: 9, esforç: 10, modul: 'General', item: 21, descripcio: 'Redefinir arquitectura emmagatzematge'},
            {codi: 'G8', impacte: 10, esforç: 10, modul: 'General', item: 22, descripcio: 'Motor orquestració integració dades'},
            {codi: 'I1', impacte: 8, esforç: 8, modul: 'General', item: 23, descripcio: 'Pla profiling dades'},
            {codi: 'I2', impacte: 7, esforç: 5, modul: 'General', item: 24, descripcio: 'Política selecció proveïdors cloud'},
            {codi: 'I3', impacte: 7, esforç: 6, modul: 'General', item: 18, descripcio: 'Responsables recolzament mòduls'},
            {codi: 'I4', impacte: 7, esforç: 8, modul: 'Middleware N8N/MongoDB', item: 13, descripcio: 'Configurar alta disponibilitat'},
            {codi: 'A1', impacte: 7, esforç: 6, modul: 'Jano', item: 11, descripcio: 'Automatitzar transferència IBAN'},
            {codi: 'A2', impacte: 8, esforç: 7, modul: 'General', item: 25, descripcio: 'Procés validació dades defuncions'},
            {codi: 'A3', impacte: 6, esforç: 5, modul: 'Middleware N8N/MongoDB', item: 14, descripcio: 'Política REST serveis N8N'},
            {codi: 'A4', impacte: 8, esforç: 7, modul: 'Casal TV', item: 7, descripcio: 'Migrar dades Casal a Hubspot'},
            {codi: 'A5', impacte: 7, esforç: 7, modul: 'Llars connectades', item: 32, descripcio: 'Integrar Llars al data lake'},
            {codi: 'A6', impacte: 7, esforç: 5, modul: 'Llars connectades', item: 15, descripcio: 'Automatitzar alta Campus Suara'},
            {codi: 'D1', impacte: 7, esforç: 7, modul: 'General', item: 26, descripcio: 'Estandarditzar documentació'},
            {codi: 'D2', impacte: 6, esforç: 4, modul: 'General', item: 33, descripcio: 'Recabar documentació tècnica'},
            {codi: 'D3', impacte: 6, esforç: 7, modul: 'Llars connectades', item: 17, descripcio: 'Mapa dades Llars connectades'}
        ];

        // Colors per mòdul
        const modulColors = {
            'SAP': '#FF6B6B',
            'Hubspot i Drupal': '#4ECDC4',
            'General': '#45B7D1',
            'Jano': '#96CEB4',
            'Casal TV': '#FECA57',
            'Llars connectades': '#FF9FF3',
            'Middleware N8N/MongoDB': '#54A0FF'
        };

        // Funció millorada per separar punts mantenint valors originals
        function adjustOverlappingPointsWithOriginalValues(acciones) {
            const adjusted = acciones.map(a => ({
                ...a,
                displayX: a.esforç,     // Posició visual
                displayY: a.impacte,   // Posició visual
                originalX: a.esforç,   // Valor original per hover
                originalY: a.impacte   // Valor original per hover
            }));
            
            const positionMap = new Map();
            
            // Agrupar per posició original
            adjusted.forEach((accion, index) => {
                const key = `${accion.originalX}-${accion.originalY}`;
                if (!positionMap.has(key)) {
                    positionMap.set(key, []);
                }
                positionMap.get(key).push({...accion, originalIndex: index});
            });
            
            // Ajustar només posicions visuals dels punts solapats
            positionMap.forEach((group, key) => {
                if (group.length > 1) {
                    const radius = 0.12; // Separació visual menor
                    const angleStep = (2 * Math.PI) / group.length;
                    
                    group.forEach((accion, i) => {
                        if (i > 0) { // El primer punt es queda al centre
                            const angle = i * angleStep;
                            const offsetX = radius * Math.cos(angle);
                            const offsetY = radius * Math.sin(angle);
                            
                            // Només canviar posició visual, mantenir valors originals
                            adjusted[accion.originalIndex].displayX += offsetX;
                            adjusted[accion.originalIndex].displayY += offsetY;
                        }
                    });
                }
            });
            
            return adjusted;
        }

        // Crear traces amb valors originals preservats
        const moduls = [...new Set(acciones.map(a => a.modul))];
        const adjustedAcciones = adjustOverlappingPointsWithOriginalValues(acciones);
        
        let originalTraces = moduls.map(modul => {
            const accionesModul = adjustedAcciones.filter(a => a.modul === modul);
            return {
                x: accionesModul.map(a => a.displayX),        // Posició visual
                y: accionesModul.map(a => a.displayY),        // Posició visual
                text: accionesModul.map(a => a.codi),
                customdata: accionesModul.map(a => ({
                    codi: a.codi,
                    item: a.item,
                    descripcio: a.descripcio,
                    modul: a.modul,
                    originalX: a.originalX,                    // Valor original
                    originalY: a.originalY                     // Valor original
                })),
                mode: 'markers+text',
                type: 'scatter',
                name: modul,
                marker: {
                    color: modulColors[modul],
                    size: 16,                                  // Punts més grans
                    line: { color: 'white', width: 2 }
                },
                textposition: 'middle center',
                textfont: { 
                    color: '#2c3e50', 
                    size: 11, 
                    family: 'Arial Black' 
                },
                hovertemplate: 
                    '<b>%{customdata.codi}</b> (Item %{customdata.item})<br>' +
                    'Impacte: %{customdata.originalY}<br>' +              // Valor original
                    'Esforç: %{customdata.originalX}<br>' +               // Valor original
                    'Mòdul: %{customdata.modul}<br>' +
                    '%{customdata.descripcio}<br>' +
                    '<extra></extra>'
            };
        });

        const layout = {
            title: {
                text: '',
                font: { size: 18, color: '#2c3e50' }
            },
            xaxis: {
                title: 'ESFORÇ →',
                range: [0, 11],
                dtick: 1,
                showgrid: true,
                gridcolor: 'rgba(128,128,128,0.3)',
                zeroline: false
            },
            yaxis: {
                title: '↑ IMPACTE',
                range: [0, 11],
                dtick: 1,
                showgrid: true,
                gridcolor: 'rgba(128,128,128,0.3)',
                zeroline: false
            },
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.35,
                x: 0.5,
                xanchor: 'center'
            },
            plot_bgcolor: 'white',
            paper_bgcolor: 'white',
            margin: { t: 60, b: 150, l: 60, r: 40 },
            shapes: [
                {
                    type: 'line',
                    x0: 5.5, x1: 5.5,
                    y0: 0, y1: 11,
                    line: { color: 'rgba(128,128,128,0.5)', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: 0, x1: 11,
                    y0: 7.5, y1: 7.5,
                    line: { color: 'rgba(128,128,128,0.5)', width: 2, dash: 'dash' }
                }
            ],
            annotations: [
                { x: 2.75, y: 9.5, text: 'QUICK WINS', showarrow: false, font: { size: 12, color: '#5a5a5a' } },
                { x: 8.25, y: 9.5, text: 'MAJOR PROJECTS', showarrow: false, font: { size: 12, color: '#5a5a5a' } },
                { x: 2.75, y: 3.75, text: 'PROPOSTES ACCESSÒRIES', showarrow: false, font: { size: 12, color: '#5a5a5a' } },
                { x: 8.25, y: 3.75, text: 'BAIX RETORN', showarrow: false, font: { size: 12, color: '#5a5a5a' } }
            ]
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
            displaylogo: false,
            toImageButtonOptions: {
                format: 'png',
                filename: 'matriu_impacte_esforç_suara',
                height: 800,
                width: 1200,
                scale: 2
            }
        };

        // Crear el gràfic
        Plotly.newPlot('chartDiv', originalTraces, layout, config);

        // Funcions de control (sense canvis)
        function showAllCategories() {
            Plotly.newPlot('chartDiv', originalTraces, layout, config);
            updateActiveButton(0);
        }

        function filterByCategory(categoryPrefix) {
            const categoryActions = adjustedAcciones.filter(a => a.codi.startsWith(categoryPrefix));
            
            const filteredTraces = moduls.map(modul => {
                const accionesModul = categoryActions.filter(a => a.modul === modul);
                
                if (accionesModul.length === 0) {
                    return {
                        x: [], y: [], text: [], customdata: [],
                        mode: 'markers+text', type: 'scatter', name: modul,
                        marker: { color: modulColors[modul], size: 16, line: { color: 'white', width: 2 } },
                        visible: false
                    };
                }
                
                return {
                    x: accionesModul.map(a => a.displayX),
                    y: accionesModul.map(a => a.displayY),
                    text: accionesModul.map(a => a.codi),
                    customdata: accionesModul.map(a => ({
                        codi: a.codi,
                        item: a.item,
                        descripcio: a.descripcio,
                        modul: a.modul,
                        originalX: a.originalX,
                        originalY: a.originalY
                    })),
                    mode: 'markers+text',
                    type: 'scatter',
                    name: modul,
                    marker: {
                        color: modulColors[modul],
                        size: 16,
                        line: { color: 'white', width: 2 }
                    },
                    textposition: 'middle center',
                    textfont: { color: '#2c3e50', size: 11, family: 'Arial Black' },
                    hovertemplate: 
                        '<b>%{customdata.codi}</b> (Item %{customdata.item})<br>' +
                        'Impacte: %{customdata.originalY}<br>' +
                        'Esforç: %{customdata.originalX}<br>' +
                        'Mòdul: %{customdata.modul}<br>' +
                        '%{customdata.descripcio}<br>' +
                        '<extra></extra>'
                };
            });
            
            Plotly.newPlot('chartDiv', filteredTraces, layout, config);
            
            const buttons = document.querySelectorAll('.control-btn');
            const categoryNames = {
                'S': 'Seguretat de la Informació',
                'G': 'Governança i Arquitectura',
                'I': 'Infraestructura',
                'A': 'Automatització i Integració',
                'D': 'Documentació i Estandardització'
            };
            
            buttons.forEach((btn, i) => {
                const isActive = btn.textContent.trim() === categoryNames[categoryPrefix];
                btn.classList.toggle('active', isActive);
            });
        }

        function filterByPriority(priority) {
            let itemsToShow = [];
            
            switch(priority) {
                case 'urgent':
                    // Items 1-9 + S6 (item 29 - compliment legal)
                    itemsToShow = [1, 2, 3, 4, 5, 6, 7, 8, 9, 29];
                    break;
                case 'mitjana':
                    // Items 10-18 + A5 (item 32) + D2 (item 33)
                    itemsToShow = [10, 11, 12, 13, 14, 15, 16, 17, 18, 32, 33];
                    break;
                case 'estrategica':
                    // Items 19-28 + G3 (item 30) + G6 (item 31)
                    itemsToShow = [19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30, 31];
                    break;
            }
            
            // Filtrar acciones per item number
            const priorityActions = adjustedAcciones.filter(a => itemsToShow.includes(a.item));
            
            // Crear nous traces només amb la prioritat seleccionada
            const filteredTraces = moduls.map(modul => {
                const accionesModul = priorityActions.filter(a => a.modul === modul);
                
                if (accionesModul.length === 0) {
                    return {
                        x: [], y: [], text: [], customdata: [],
                        mode: 'markers+text', type: 'scatter', name: modul,
                        marker: { color: modulColors[modul], size: 16, line: { color: 'white', width: 2 } },
                        visible: false
                    };
                }
                
                return {
                    x: accionesModul.map(a => a.displayX),
                    y: accionesModul.map(a => a.displayY),
                    text: accionesModul.map(a => a.codi),
                    customdata: accionesModul.map(a => ({
                        codi: a.codi,
                        item: a.item,
                        descripcio: a.descripcio,
                        modul: a.modul,
                        originalX: a.originalX,
                        originalY: a.originalY
                    })),
                    mode: 'markers+text',
                    type: 'scatter',
                    name: modul,
                    marker: {
                        color: modulColors[modul],
                        size: 16,
                        line: { color: 'white', width: 2 }
                    },
                    textposition: 'middle center',
                    textfont: { color: '#2c3e50', size: 11, family: 'Arial Black' },
                    hovertemplate: 
                        '<b>%{customdata.codi}</b> (Item %{customdata.item})<br>' +
                        'Impacte: %{customdata.originalY}<br>' +
                        'Esforç: %{customdata.originalX}<br>' +
                        'Mòdul: %{customdata.modul}<br>' +
                        '%{customdata.descripcio}<br>' +
                        '<extra></extra>'
                };
            });
            
            Plotly.newPlot('chartDiv', filteredTraces, layout, config);
            
            // Actualitzar botó actiu
            const buttons = document.querySelectorAll('.control-btn');
            const priorityNames = {
                'urgent': 'Prioritat Urgent',
                'mitjana': 'Prioritat Mitjana',
                'estrategica': 'Prioritat Estratègica'
            };
            
            buttons.forEach((btn, i) => {
                const isActive = btn.textContent.trim() === priorityNames[priority];
                btn.classList.toggle('active', isActive);
            });
        }

        function resetZoom() {
            showAllCategories();
            Plotly.relayout('chartDiv', {
                'xaxis.range': [0, 11],
                'yaxis.range': [0, 11]
            });
        }
    </script>
</body>
</html>
